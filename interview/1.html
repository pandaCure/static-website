<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Javascript 中为什么 0.1 + 0.2 === 0.3? | 钟繇</title>
    <meta name="description" content="JavaScript知识点">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="icon" href="/static-website/logo.png">
  <link rel="manifest" href="/static-website/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/static-website/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/static-website/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/static-website/assets/css/0.styles.57852ca5.css" as="style"><link rel="preload" href="/static-website/assets/js/app.f88d7d01.js" as="script"><link rel="preload" href="/static-website/assets/js/2.2eca4bf4.js" as="script"><link rel="preload" href="/static-website/assets/js/3.1e0dcc23.js" as="script"><link rel="prefetch" href="/static-website/assets/js/10.31762d9c.js"><link rel="prefetch" href="/static-website/assets/js/11.1388b91e.js"><link rel="prefetch" href="/static-website/assets/js/12.6c41a5d5.js"><link rel="prefetch" href="/static-website/assets/js/13.57bed441.js"><link rel="prefetch" href="/static-website/assets/js/14.8494dca0.js"><link rel="prefetch" href="/static-website/assets/js/15.f81cb783.js"><link rel="prefetch" href="/static-website/assets/js/16.5ff32def.js"><link rel="prefetch" href="/static-website/assets/js/17.420322f1.js"><link rel="prefetch" href="/static-website/assets/js/18.deb54590.js"><link rel="prefetch" href="/static-website/assets/js/19.ec3a94c6.js"><link rel="prefetch" href="/static-website/assets/js/20.e29b6e45.js"><link rel="prefetch" href="/static-website/assets/js/21.65b4e263.js"><link rel="prefetch" href="/static-website/assets/js/22.12a7eb8c.js"><link rel="prefetch" href="/static-website/assets/js/23.48ff6209.js"><link rel="prefetch" href="/static-website/assets/js/4.90f737ae.js"><link rel="prefetch" href="/static-website/assets/js/5.6628d2b0.js"><link rel="prefetch" href="/static-website/assets/js/6.91340e0b.js"><link rel="prefetch" href="/static-website/assets/js/7.12cc6f32.js"><link rel="prefetch" href="/static-website/assets/js/8.62ddc07b.js"><link rel="prefetch" href="/static-website/assets/js/9.422ba233.js">
    <link rel="stylesheet" href="/static-website/assets/css/0.styles.57852ca5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/static-website/" class="home-link router-link-active"><!----> <span class="site-name">钟繇</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/static-website/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/static-website/topics/" class="nav-link">
  知识点
</a></div><div class="nav-item"><a href="/static-website/just-javascript/" class="nav-link">
  Just Javascript对照翻译
</a></div><div class="nav-item"><a href="/static-website/interview/" class="nav-link router-link-active">
  面试题
</a></div><div class="nav-item"><a href="/static-website/origin/" class="nav-link">
  源码系列
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/static-website/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/static-website/topics/" class="nav-link">
  知识点
</a></div><div class="nav-item"><a href="/static-website/just-javascript/" class="nav-link">
  Just Javascript对照翻译
</a></div><div class="nav-item"><a href="/static-website/interview/" class="nav-link router-link-active">
  面试题
</a></div><div class="nav-item"><a href="/static-website/origin/" class="nav-link">
  源码系列
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>面试题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/static-website/interview/1.html" class="active sidebar-link">Javascript 中为什么 0.1 + 0.2 === 0.3?</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/static-website/interview/1.html#ieee754" class="sidebar-link">IEEE754</a></li><li class="sidebar-sub-header"><a href="/static-website/interview/1.html#javascript-是如何表示数字的？" class="sidebar-link">JavaScript 是如何表示数字的？</a></li><li class="sidebar-sub-header"><a href="/static-website/interview/1.html#根据-ieee754-计算-0-1-0-2" class="sidebar-link">根据 IEEE754 计算 0.1+0.2</a></li><li class="sidebar-sub-header"><a href="/static-website/interview/1.html#计算-javascript-number-的特性" class="sidebar-link">计算 javascript Number 的特性</a></li></ul></li><li><a href="/static-website/interview/2.html" class="sidebar-link">手写Promise</a></li><li><a href="/static-website/interview/3.html" class="sidebar-link">关于BigInt</a></li><li><a href="/static-website/interview/4.html" class="sidebar-link">javascript String 类型</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="javascript-中为什么-0-1-0-2-0-3"><a href="#javascript-中为什么-0-1-0-2-0-3" class="header-anchor">#</a> Javascript 中为什么 0.1 + 0.2 === 0.3?</h1> <p>Number 作为 JavaScript 中的基本类型，无论是整数还是小数其类型都是双精度 IEEE754 64 位浮点类型。但是这就造成了一个精确计算的问题：0.1 + 0.2 === 0.3? 在浏览器控制台打印出来：</p> <p><img src="/static-website/assets/img/1.4e270389.png" alt="打印结果"></p> <p>这种送分题，js 却送了命。令人窒息的操作。这个例子很常见，我们不是为了关注这个例子本身，我们需要明白的是为什么会出现这样的结果？哪一步出了问题？还有那些计算可能会出现这样的问题？怎么解决？</p> <h2 id="ieee754"><a href="#ieee754" class="header-anchor">#</a> IEEE754</h2> <p>在 IEEE754 中，双精度浮点数储存为 64 位：</p> <p><img src="/static-website/assets/img/2.818cce77.png" alt="双精度浮点数"></p> <p>指数位可以通过下面的方法转换为使用的指数值：</p> <p><img src="/static-website/assets/img/3.2ffdde92.png" alt="使用的指数值"></p> <p>浮点数表示的值的形式由 <code>e</code> 和 <code>f</code> 确定。
这里有个疑问：</p> <ul><li>为什么 bias 是 1~2046？是因为指数位没有办法表示-1 等复数，所以 e=1024，base 就等于-1。</li> <li>为什么<code>2 ** 11</code>要减1,因为二进制<code>0b11111111111</code>的最大值是<code>2 ** 11</code></li></ul> <h2 id="javascript-是如何表示数字的？"><a href="#javascript-是如何表示数字的？" class="header-anchor">#</a> JavaScript 是如何表示数字的？</h2> <p>JavaScript 使用 Number 类型表示数字（整数和浮点数），遵循 IEEE 754 标准 通过 64 位来表示一个数字</p> <p>通过图片具体看一下数字在内存中的表示:</p> <p><img src="/static-website/assets/img/4.6208c7c0.png" alt="数字在内存中"></p> <p>图片文字说明</p> <ul><li>第 0 位：符号位，0 表示正数，1 表示负数(s)</li> <li>第 1 位到第 11 位：储存指数部分（e）</li> <li>第 12 位到第 63 位：储存小数部分（即有效数字）f</li></ul> <h2 id="根据-ieee754-计算-0-1-0-2"><a href="#根据-ieee754-计算-0-1-0-2" class="header-anchor">#</a> 根据 IEEE754 计算 0.1+0.2</h2> <h3 id="_1-将-0-1-使用转换为二进制"><a href="#_1-将-0-1-使用转换为二进制" class="header-anchor">#</a> 1. 将 0.1 使用转换为二进制</h3> <p><img src="/static-website/assets/img/6.deadc8a4.png" alt="0.1"></p> <p>由于小数位 仅储存 52bit, 储存时会将超出精度部分进行&quot;零舍一入&quot;</p> <table><thead><tr><th>值类型</th> <th>小数位(储存范围内)</th> <th>小数位(储存范围外)</th></tr></thead> <tbody><tr><td>无限精确值</td> <td>1001 1001 1001 1001 1001 1001 1001 1001 1001 1001 1001 1001 1001</td> <td>1001 1001...</td></tr> <tr><td>实际储存值</td> <td>1001 1001 1001 1001 1001 1001 1001 1001 1001 1001 1001 1001 1010</td> <td>-</td></tr></tbody></table> <p>由于计算加减时不会对指数位进行位运算，这里不计算指数位的表示，直接使用数字表示最终的指数值</p> <p>0.1、0.2 的表示如下：</p> <table><thead><tr><th>浮点数数值</th> <th>符号位 <code>s</code></th> <th>指数值 <code>E</code></th> <th>小数位 <code>f</code></th></tr></thead> <tbody><tr><td>0.1</td> <td>0</td> <td>-4</td> <td>1001 1001 1001 1001 1001 1001 1001 1001 1001 1001 1001 1001 1010</td></tr> <tr><td>0.2</td> <td>0</td> <td>-3</td> <td>1001 1001 1001 1001 1001 1001 1001 1001 1001 1001 1001 1001 1010</td></tr></tbody></table> <h3 id="_2-将-0-1-与-0-2-相加"><a href="#_2-将-0-1-与-0-2-相加" class="header-anchor">#</a> 2. 将 0.1 与 0.2 相加</h3> <p>在计算浮点数相加时需要先进行“对位”，将较小的指数化为较大的指数，并将小数部分相应右移</p> <p><img src="/static-website/assets/img/7.faf3c058.png" alt="将 0.1 与 0.2 相加"></p> <p>可以通过下面的方法检验计算结果是否于 js 中一致：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token number">0.1</span> <span class="token operator">+</span> <span class="token number">0.2</span> <span class="token operator">===</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">0</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token operator">**</span><span class="token operator">-</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0b10011001100110011001100110011001100110011001100110100</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token operator">**</span><span class="token operator">-</span><span class="token number">52</span><span class="token punctuation">)</span>
<span class="token comment">//&gt; true</span>
<span class="token comment">//计算正确</span>
</code></pre></div><h2 id="计算-javascript-number-的特性"><a href="#计算-javascript-number-的特性" class="header-anchor">#</a> 计算 javascript Number 的特性</h2> <p>在js中 Number对象上附带了许多属性，表示可数的范围等信息，例如 Number.MAX_SAFE_INTEGER 是一个16位的数字，这一部分将解释如何计算出这些有特殊意义的数字</p> <h3 id="_1-计算-number-max-value-和-number-min-value"><a href="#_1-计算-number-max-value-和-number-min-value" class="header-anchor">#</a> 1.计算 Number.MAX_VALUE 和 Number.MIN_VALUE</h3> <p>当符号位为0、指数取到1023、小数位全为1时，为可表示的最大值</p> <p>当符号位为0、指数位全为0（表示非规格浮点数）、小数位仅最后一位为1时，为可表示的最小正值</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> max <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">0</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token operator">**</span><span class="token number">1023</span> <span class="token operator">*</span> <span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">53</span><span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token operator">**</span><span class="token operator">-</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
max <span class="token operator">===</span> Number<span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
<span class="token comment">//&gt; true</span>

<span class="token keyword">var</span> min <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">0</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token operator">**</span><span class="token operator">-</span><span class="token number">1022</span> <span class="token operator">*</span> <span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;1&quot;</span> <span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token operator">**</span><span class="token operator">-</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
min <span class="token operator">===</span> Number<span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">;</span>
<span class="token comment">//&gt; true</span>
</code></pre></div><h3 id="_2-计算-number-max-safe-integer-和-number-min-safe-integer"><a href="#_2-计算-number-max-safe-integer-和-number-min-safe-integer" class="header-anchor">#</a> 2.计算 Number.MAX_SAFE_INTEGER 和 Number.MIN_SAFE_INTEGER</h3> <p><code>Number.MAX_SAFE_INTEGER</code>表示最大安全整数，它是9开头的16位数字，也表明js number最大精度不超过16位。</p> <p>ECMASCRIPT-262 定义：</p> <blockquote><p>The value of Number.MAX_SAFE_INTEGER is the largest integer n such that n &gt;and n + 1 are both exactly representable as a Number value. <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-number.max_safe_integer" target="_blank" rel="noopener noreferrer">http://www.ecma-international<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>...</p></blockquote> <p>既然说到这里，再给大家科普一个小知识点：js 最大安全数是 Number. MAX_SAFE_INTEGER == Math.pow(2, 53) - 1, 而不是 Math.pow(2, 52) - 1, why？尾数部分不是只有 52 位吗?</p> <p>这是因为二进制表示有效数字总是 1.xx…xx 的形式，尾数部分 f 在规约形式下第一位默认为 1（省略不写，xx..xx 为尾数部分 f，最长 52 位）。因此，JavaScript 提供的有效数字最长为 53 个二进制位（64 位浮点的后 52 位+被省略的 1 位）</p> <p>改变指数位为53，这让每个小数位都表示浮点数的整数部分，小数位最低位对应 ，然后将每个小数位都置1，可得最大准确整数：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> max_safe_int <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">0</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token operator">**</span><span class="token number">52</span> <span class="token operator">*</span> <span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">53</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token operator">**</span><span class="token operator">-</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
max_safe_int <span class="token operator">===</span> Number<span class="token punctuation">.</span><span class="token constant">MAX_SAFE_INTEGER</span><span class="token punctuation">;</span>
<span class="token comment">//&gt; true</span>
<span class="token comment">//当它 +1 时，可由 (-1)**0 * 2**53 * (Number.parseInt(&quot;1&quot;+&quot;0&quot;.repeat(52),2) * 2**-52) 正确表示，而再 +1 时则无法准确表示</span>

<span class="token comment">//符号位取反可得最小安全整数</span>
<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">*</span> max_safe_int <span class="token operator">===</span> Number<span class="token punctuation">.</span><span class="token constant">MIN_SAFE_INTEGER</span><span class="token punctuation">;</span>
</code></pre></div><p>简单验证一下</p> <p><img src="/static-website/assets/img/5.eeeba3ff.png" alt="简单验证一下"></p> <h3 id="_3-计算-number-epsilon"><a href="#_3-计算-number-epsilon" class="header-anchor">#</a> 3.计算 Number.EPSILON</h3> <p>Number.EPSILON 是一个极小值。<em>但并不是用来检测误差范围内的值</em>。 例如：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token number">0.1</span> <span class="token operator">+</span> <span class="token number">0.2</span> <span class="token operator">-</span> <span class="token number">0.3</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> Number<span class="token punctuation">.</span><span class="token constant">EPSILON</span><span class="token punctuation">;</span>
<span class="token comment">//&gt; true</span>

<span class="token comment">//2017-9-27 补充</span>
<span class="token number">1.1</span> <span class="token operator">+</span> <span class="token number">1.3</span> <span class="token operator">-</span> <span class="token number">2.4</span> <span class="token operator">&lt;</span> Number<span class="token punctuation">.</span><span class="token constant">EPSILON</span>
<span class="token comment">//&gt; false</span>
</code></pre></div><p>根据 ECMASCRIPT-262 定义：</p> <blockquote><p>The value of Number.EPSILON is the difference between 1 and the smallest value greater than 1 that is representable as a Number value, which is approximately 2.2204460492503130808472633361816 x 10‍−‍16.</p></blockquote> <p><a href="http://www.ecma-international.org/ecma-262/6.0/#sec-number.epsilon" target="_blank" rel="noopener noreferrer">规范地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>根据定义Number.EPSILON是大于1的最小可表示数与1的差，可以据此计算出 Number.EPSILON 的值：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//将表示1的二进制小数位的最左端置1，可表示大于1的最小数</span>
<span class="token keyword">var</span> epsilon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">0</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token operator">**</span><span class="token number">0</span> <span class="token operator">*</span> <span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token operator">+</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token operator">**</span><span class="token operator">-</span><span class="token number">52</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">// (-1)**0 * 2**0 * (+`0b1${&quot;0&quot;.repeat(51)}1` * 2**-52) - 1;</span>
epsilon <span class="token operator">===</span> Number<span class="token punctuation">.</span><span class="token constant">EPSILON</span><span class="token punctuation">;</span>
<span class="token comment">//&gt; true</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/static-website/interview/2.html">
        手写Promise
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/static-website/assets/js/app.f88d7d01.js" defer></script><script src="/static-website/assets/js/2.2eca4bf4.js" defer></script><script src="/static-website/assets/js/3.1e0dcc23.js" defer></script>
  </body>
</html>
